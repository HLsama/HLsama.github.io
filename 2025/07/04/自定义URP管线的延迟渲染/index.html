
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>自定义URP管线的延迟渲染 | 枫雪のHome</title>
    <meta name="author" content="枫雪" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>


<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/KaTeX/0.16.9/katex.min.css" />
<script src="/js/lib/math.js"></script>


<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>枫雪のHOME</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;主页</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;关于我</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;归档</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;分类</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;标签</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;枫雪のHOME</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">主页</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">关于我</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">归档</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">分类</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">标签</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>自定义URP管线的延迟渲染</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/7/4
        </span>
        
        
    </div>
    
    <div class="content" v-pre>
        <p>这是一段代码测试</p>
<span id="more"></span>
<p>一下为测试代码</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode glsl"><code class="sourceCode glsl"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">//Include</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">//引用关于BitTex相关的库，来拿到摄象机传来的图</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include &quot;Packages/com.unity.render-pipelines.core/Runtime/Utilities/Blit.hlsl&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">//Texture&amp; Samplers</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>float4 _BlitTexture_TexelSize<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">TEXTURE2D_X_FLOAT</span><span class="op">(</span>_CameraDepthTexture<span class="op">);</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">TEXTURE2D_X_FLOAT</span><span class="op">(</span>_CameraNormalsTexture<span class="op">);</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">SAMPLER</span><span class="op">(</span>sampler_CameraNormalsTexture<span class="op">);</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">SAMPLER</span><span class="op">(</span>sampler_CameraDepthTexture<span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>Texture2D _HierarchicalZBufferTexture<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Params</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">//重构世界坐标相关参数</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>float4 _CameraViewTopLeftCorner<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>float4 _CameraViewXExtent<span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>float4 _CameraViewYExtent<span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>float4 _ProjectionParams2<span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">//光线步进相关参数</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> _Stride<span class="op">;</span><span class="co">//步幅</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> _Thickness<span class="op">;</span><span class="co">//厚度</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> _StepCount<span class="op">;</span><span class="co">//最大步进次数</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> _MaxDistance<span class="op">;</span><span class="co">//最大步进长度</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>float4 _SourceSize<span class="op">;</span><span class="co">//原图尺寸</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> _MipCount2<span class="op">;</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co">//HiZ相关参数</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> _HierarchicalZBufferTextureFromMipLevel<span class="op">;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> _HierarchicalZBufferTextureToMipLevel<span class="op">;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> _MaxHierarchicalZBufferTextureMipLevel<span class="op">;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co">//结构体</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> appdata</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint</span> vertexID <span class="op">:</span> SV_VertexID<span class="op">;</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    UNITY_VERTEX_INPUT_INSTANCE_ID</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;;</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> v2f</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    float2 uv <span class="op">:</span> TEXCOORD0<span class="op">;</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    float4 vertex <span class="op">:</span> SV_POSITION<span class="op">;</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;;</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co">//计算相对于摄象机的偏移值</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>float3 <span class="fu">ReconstructViewPos</span><span class="op">(</span>float2 uv<span class="op">,</span><span class="dt">float</span> Depth<span class="op">)</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    uv<span class="op">.</span><span class="fu">y</span> <span class="op">=</span> <span class="dv">1</span><span class="op">-</span>uv<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> zSize <span class="op">=</span> Depth<span class="op">*</span>_ProjectionParams2<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    float3 viewPos <span class="op">=</span> _CameraViewTopLeftCorner<span class="op">.</span><span class="fu">xyz</span><span class="op">+</span>_CameraViewXExtent<span class="op">*</span>uv<span class="op">.</span><span class="fu">x</span><span class="op">+</span>_CameraViewYExtent<span class="op">*</span>uv<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> zSize<span class="op">*</span>viewPos<span class="op">;</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co">//每步步进的uv与深度</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">ReconstructUVAndDepth</span><span class="op">(</span>float3 wpos<span class="op">,</span> <span class="dt">out</span> float2 uv<span class="op">,</span> <span class="dt">out</span> <span class="dt">float</span> depth<span class="op">)</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span>  </span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    float4 cpos <span class="op">=</span> <span class="fu">mul</span><span class="op">(</span>UNITY_MATRIX_VP<span class="op">,</span> wpos<span class="op">);</span>  </span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    uv <span class="op">=</span> <span class="fu">float2</span><span class="op">(</span>cpos<span class="op">.</span><span class="fu">x</span><span class="op">,</span> cpos<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> _ProjectionParams<span class="op">.</span><span class="fu">x</span><span class="op">)</span> <span class="op">/</span> cpos<span class="op">.</span><span class="fu">w</span> <span class="op">*</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.5</span><span class="op">;</span>  </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>    depth <span class="op">=</span> cpos<span class="op">.</span><span class="fu">w</span><span class="op">;</span>  </span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co">//变换坐标到屏幕空间</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>float4 <span class="fu">TransformViewToHScreen</span><span class="op">(</span>float3 vpos<span class="op">,</span> float2 screenSize<span class="op">)</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span>  </span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    float4 cpos <span class="op">=</span> <span class="fu">mul</span><span class="op">(</span>UNITY_MATRIX_P<span class="op">,</span> vpos<span class="op">);</span>  </span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    cpos<span class="op">.</span><span class="fu">xy</span> <span class="op">=</span> <span class="fu">float2</span><span class="op">(</span>cpos<span class="op">.</span><span class="fu">x</span><span class="op">,</span> cpos<span class="op">.</span><span class="fu">y</span> <span class="op">*</span> _ProjectionParams<span class="op">.</span><span class="fu">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.5</span> <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> cpos<span class="op">.</span><span class="fu">w</span><span class="op">;</span>  </span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    cpos<span class="op">.</span><span class="fu">xy</span> <span class="op">*=</span> screenSize<span class="op">;</span>  </span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> cpos<span class="op">;</span>  </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span>  </span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co">//交换数据</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">swap</span><span class="op">(</span><span class="dt">inout</span> <span class="dt">float</span> v0<span class="op">,</span> <span class="dt">inout</span> <span class="dt">float</span> v1<span class="op">)</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span>  </span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> temp <span class="op">=</span> v0<span class="op">;</span>  </span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    v0 <span class="op">=</span> v1<span class="op">;</span>    </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    v1 <span class="op">=</span> temp<span class="op">;</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="co">//获取源图</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>float4 <span class="fu">GetSource</span><span class="op">(</span>float2 uv<span class="op">)</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    float4 col <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X</span><span class="op">(</span>_BlitTexture<span class="op">,</span> sampler_LinearClamp<span class="op">,</span> uv<span class="op">);</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> col<span class="op">;</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="co">//深度图</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">SampleSceneDepth</span><span class="op">(</span>float2 uv<span class="op">)</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> Depth <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X</span><span class="op">(</span>_CameraDepthTexture<span class="op">,</span>sampler_CameraDepthTexture<span class="op">,</span>uv<span class="op">).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Depth<span class="op">;</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>float4 <span class="fu">GetHiZSoure</span><span class="op">(</span>float2 uv<span class="op">,</span>float2 <span class="dt">offset</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span><span class="dt">float</span> mipLevel <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    <span class="dt">offset</span> <span class="op">*=</span> _SourceSize<span class="op">.</span><span class="fu">zw</span><span class="op">;</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">SAMPLE_TEXTURE2D_X_LOD</span><span class="op">(</span>_BlitTexture<span class="op">,</span> sampler_LinearRepeat<span class="op">,</span> uv <span class="op">+</span> <span class="dt">offset</span><span class="op">,</span> mipLevel<span class="op">);</span></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a><span class="co">// jitter dither map</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>static <span class="dt">float</span> dither<span class="op">[</span><span class="dv">16</span><span class="op">]</span> <span class="op">=</span> <span class="op">&#123;</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.0</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> <span class="fl">0.125</span><span class="op">,</span> <span class="fl">0.625</span><span class="op">,</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.75</span><span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.875</span><span class="op">,</span> <span class="fl">0.375</span><span class="op">,</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.187</span><span class="op">,</span> <span class="fl">0.687</span><span class="op">,</span> <span class="fl">0.0625</span><span class="op">,</span> <span class="fl">0.562</span><span class="op">,</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.937</span><span class="op">,</span> <span class="fl">0.437</span><span class="op">,</span> <span class="fl">0.812</span><span class="op">,</span> <span class="fl">0.312</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;;</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="co">//通用顶点着色器</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>v2f <span class="fu">vert</span> <span class="op">(</span>appdata v<span class="op">)</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    v2f o<span class="op">;</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    o<span class="op">.</span><span class="fu">vertex</span> <span class="op">=</span> <span class="fu">GetFullScreenTriangleVertexPosition</span><span class="op">(</span>v<span class="op">.</span><span class="fu">vertexID</span><span class="op">);</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">//参考了官方bloom的uv拿法</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    float2 uv <span class="op">=</span> <span class="fu">GetFullScreenTriangleTexCoord</span><span class="op">(</span>v<span class="op">.</span><span class="fu">vertexID</span><span class="op">);</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    o<span class="op">.</span><span class="fu">uv</span><span class="op">=</span> uv <span class="op">*</span> _BlitScaleBias<span class="op">.</span><span class="fu">xy</span> <span class="op">+</span> _BlitScaleBias<span class="op">.</span><span class="fu">zw</span><span class="op">;</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> o<span class="op">;</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a><span class="co">//SSR用片源着色器</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>float4 <span class="fu">SSRfrag</span> <span class="op">(</span>v2f i<span class="op">)</span> <span class="op">:</span> SV_Target</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">//采样数据</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>    float2 uv <span class="op">=</span> <span class="fu">UnityStereoTransformScreenSpaceTex</span><span class="op">(</span>i<span class="op">.</span><span class="fu">uv</span><span class="op">);</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> Depth <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X</span><span class="op">(</span>_CameraDepthTexture<span class="op">,</span>sampler_CameraDepthTexture<span class="op">,</span>uv<span class="op">).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    Depth <span class="op">=</span> <span class="fu">LinearEyeDepth</span><span class="op">(</span>Depth<span class="op">,</span>_ZBufferParams<span class="op">);</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>    float3 Normal <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X</span><span class="op">(</span>_CameraNormalsTexture<span class="op">,</span>sampler_CameraNormalsTexture<span class="op">,</span>uv<span class="op">);</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>    float4 col <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X</span><span class="op">(</span>_BlitTexture<span class="op">,</span> sampler_LinearClamp<span class="op">,</span> uv<span class="op">);</span><span class="co">//采样前屏幕纹理</span></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">//深度图还原世界坐标</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    float3 viewPos <span class="op">=</span> <span class="fu">ReconstructViewPos</span><span class="op">(</span>uv<span class="op">,</span>Depth<span class="op">);</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>    float3 posWS <span class="op">=</span> _WorldSpaceCameraPos<span class="op">+</span>viewPos<span class="op">;</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">//视空间反射方向</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>    float3 vDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span>viewPos<span class="op">);</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>    float3 vrDir <span class="op">=</span> <span class="fu">TransformWorldToViewDir</span><span class="op">(</span><span class="bu">normalize</span><span class="op">(</span><span class="bu">reflect</span><span class="op">(</span>vDir<span class="op">,</span>Normal<span class="op">)));</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">//视空间的光线步进</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*UNITY_LOOP</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="co">    for(int i=0;i&lt;100;i++)</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a><span class="co">    &#123;</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="co">        float3 viewPos2 = viewPos+vrDir*i*_Stride;</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a><span class="co">        float2 uv2;  </span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a><span class="co">        float stepDepth;  </span></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a><span class="co">        ReconstructUVAndDepth(viewPos2, uv2, stepDepth);</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a><span class="co">        float stepRawDepth = SAMPLE_TEXTURE2D_X(_CameraDepthTexture,sampler_CameraDepthTexture,uv2).r;  </span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a><span class="co">        float stepSurfaceDepth = LinearEyeDepth(stepRawDepth, _ZBufferParams);  </span></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a><span class="co">        if (stepSurfaceDepth &lt; stepDepth &amp;&amp; stepDepth &lt; stepSurfaceDepth + _Thickness)</span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a><span class="co">            return SAMPLE_TEXTURE2D_X(_BlitTexture, sampler_LinearClamp, uv2);  </span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a><span class="co">    &#125;</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a><span class="co">    return float4(0,0,0,1);*/</span></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>    <span class="co">//屏幕空间的光线步进（DDA画线法）</span></span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    <span class="co">//首先规定最大步进长度（自定义最大步进终点，这样才能DDA画线）</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> magnitude <span class="op">=</span> _MaxDistance<span class="op">;</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>    float3 startView <span class="op">=</span> <span class="fu">TransformWorldToView</span><span class="op">(</span>posWS<span class="op">);</span><span class="co">//视空间起点</span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> end <span class="op">=</span> startView<span class="op">.</span><span class="fu">z</span> <span class="op">+</span> vrDir<span class="op">.</span><span class="fu">z</span> <span class="op">*</span> magnitude<span class="op">;</span></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>end <span class="op">&gt;</span> <span class="op">-</span>_ProjectionParams<span class="op">.</span><span class="fu">y</span><span class="op">)</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>        magnitude <span class="op">=</span> <span class="op">(-</span>_ProjectionParams<span class="op">.</span><span class="fu">y</span> <span class="op">-</span> startView<span class="op">.</span><span class="fu">z</span><span class="op">)</span> <span class="op">/</span> vrDir<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>    float3 endView <span class="op">=</span> startView<span class="op">+</span>vrDir<span class="op">*</span>magnitude<span class="op">;</span><span class="co">//视空间终点</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>    float4 startHScreen <span class="op">=</span> <span class="fu">TransformViewToHScreen</span><span class="op">(</span>startView<span class="op">,</span> _SourceSize<span class="op">.</span><span class="fu">xy</span><span class="op">);</span><span class="co">//屏幕空间起点</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>    float4 endHScreen <span class="op">=</span> <span class="fu">TransformViewToHScreen</span><span class="op">(</span>endView<span class="op">,</span> _SourceSize<span class="op">.</span><span class="fu">xy</span><span class="op">);</span><span class="co">//屏幕空间终点</span></span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>    <span class="co">//1/k</span></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> startK <span class="op">=</span> <span class="fl">1.0</span><span class="op">/</span>startHScreen<span class="op">.</span><span class="fu">w</span><span class="op">;</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> endK <span class="op">=</span> <span class="fl">1.0</span><span class="op">/</span>endHScreen<span class="op">.</span><span class="fu">w</span><span class="op">;</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>    <span class="co">//与之前的屏幕坐标有什么区别？？？</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>    float2 startScreen <span class="op">=</span> startHScreen<span class="op">.</span><span class="fu">xy</span><span class="op">*</span>startK<span class="op">;</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>    float2 endScreen <span class="op">=</span> endHScreen<span class="op">.</span><span class="fu">xy</span> <span class="op">*</span> endK<span class="op">;</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>    <span class="co">//齐次除法视坐标？？？？</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>    float3 startQ <span class="op">=</span> startView<span class="op">*</span>startK<span class="op">;</span></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>    float3 endQ <span class="op">=</span> endView<span class="op">*</span>endK<span class="op">;</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>    <span class="co">//斜率切换xy</span></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>    float2 diff <span class="op">=</span> endScreen<span class="op">-</span>startScreen<span class="op">;</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> permute <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>diff<span class="op">.</span><span class="fu">x</span><span class="op">)&lt;</span><span class="bu">abs</span><span class="op">(</span>diff<span class="op">.</span><span class="fu">y</span><span class="op">))</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>    <span class="op">&#123;</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>        permute <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>        diff <span class="op">=</span> diff<span class="op">.</span><span class="fu">yx</span><span class="op">;</span></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>        startScreen <span class="op">=</span> startScreen<span class="op">.</span><span class="fu">yx</span><span class="op">;</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>        endScreen <span class="op">=</span> endScreen<span class="op">.</span><span class="fu">yx</span><span class="op">;</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    <span class="op">&#125;</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>    <span class="co">//计算屏幕坐标，齐次坐标，inverse-w的线性增量</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dir <span class="op">=</span> <span class="bu">sign</span><span class="op">(</span>diff<span class="op">.</span><span class="fu">x</span><span class="op">);</span></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> invdx <span class="op">=</span> dir<span class="op">/</span>diff<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>    float2 dp <span class="op">=</span> <span class="fu">float2</span><span class="op">(</span>dir<span class="op">,</span>invdx<span class="op">*</span>diff<span class="op">.</span><span class="fu">y</span><span class="op">);</span><span class="co">//步进方向</span></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>    float3 dq <span class="op">=</span> <span class="op">(</span>endQ<span class="op">-</span>startQ<span class="op">)*</span>invdx<span class="op">;</span></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dk <span class="op">=</span> <span class="op">(</span>endK<span class="op">-</span>startK<span class="op">)*</span>invdx<span class="op">;</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>    dp <span class="op">*=</span>_Stride<span class="op">;</span><span class="co">//步进方向*距离</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>    dq <span class="op">*=</span>_Stride<span class="op">;</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>    dk <span class="op">*=</span>_Stride<span class="op">;</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>    <span class="co">//缓存当前深度和位置(为什么这些都是同一深度）</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> rayZMin <span class="op">=</span> startView<span class="op">.</span><span class="fu">z</span><span class="op">;</span>  </span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> rayZMax <span class="op">=</span> startView<span class="op">.</span><span class="fu">z</span><span class="op">;</span>  </span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> preZ <span class="op">=</span> startView<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>    float2 P <span class="op">=</span> startScreen<span class="op">;</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>    float3 Q <span class="op">=</span> startQ<span class="op">;</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> K <span class="op">=</span> startK<span class="op">;</span></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> endScreen<span class="op">.</span><span class="fu">x</span> <span class="op">*</span> dir<span class="op">;</span></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>    <span class="co">//屏幕空间光线步进</span></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>    UNITY_LOOP</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>_StepCount<span class="op">&amp;&amp;</span>P<span class="op">.</span><span class="fu">x</span><span class="op">*</span>dir<span class="op">&lt;=</span>end<span class="op">;</span>i<span class="op">++)</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    <span class="op">&#123;</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>        <span class="co">//步进</span></span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>        P <span class="op">+=</span>dp<span class="op">;</span><span class="co">//屏幕空间步进一个像素</span></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>        Q<span class="op">.</span><span class="fu">z</span> <span class="op">+=</span>dq<span class="op">.</span><span class="fu">z</span><span class="op">;</span><span class="co">//深度步进</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>        K <span class="op">+=</span>dk<span class="op">;</span><span class="co">//K值也跟着增加</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>        <span class="co">//步进前后两点的深度</span></span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>        rayZMin <span class="op">=</span> preZ<span class="op">;</span></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>        rayZMax <span class="op">=</span> <span class="op">(</span>dq<span class="op">.</span><span class="fu">z</span><span class="op">*</span><span class="fl">0.5</span><span class="op">+</span>Q<span class="op">.</span><span class="fu">z</span><span class="op">)/(</span>dk<span class="op">*</span><span class="fl">0.5</span><span class="op">+</span>K<span class="op">);</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>        preZ <span class="op">=</span> rayZMax<span class="op">;</span></span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>rayZMin<span class="op">&gt;</span>rayZMax<span class="op">)</span></span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#123;</span></span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>            <span class="fu">swap</span><span class="op">(</span>rayZMin<span class="op">,</span> rayZMax<span class="op">);</span>  </span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#125;</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>        <span class="co">//得到交点UV</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>        float2 hitUV <span class="op">=</span> permute<span class="op">?</span>P<span class="op">.</span><span class="fu">yx</span><span class="op">:</span>P<span class="op">;</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>        hitUV <span class="op">*=</span>_SourceSize<span class="op">.</span><span class="fu">zw</span><span class="op">;</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span><span class="bu">any</span><span class="op">(</span>hitUV<span class="op">&lt;</span><span class="fl">0.0</span><span class="op">)||</span><span class="bu">any</span><span class="op">(</span>hitUV<span class="op">&gt;</span><span class="fl">1.0</span><span class="op">))</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#123;</span></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fu">float4</span><span class="op">(</span>col<span class="op">);</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#125;</span></span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> surfaceDepth <span class="op">=</span> <span class="op">-</span><span class="fu">LinearEyeDepth</span><span class="op">(</span><span class="fu">SampleSceneDepth</span><span class="op">(</span>hitUV<span class="op">),</span> _ZBufferParams<span class="op">);</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> isBehind <span class="op">=</span> <span class="op">(</span>rayZMin <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&lt;=</span> surfaceDepth<span class="op">);</span><span class="co">//防止步进步数过小，自反射；</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> intersecting <span class="op">=</span> isBehind <span class="op">&amp;&amp;</span> <span class="op">(</span>rayZMax <span class="op">&gt;=</span> surfaceDepth <span class="op">-</span> _Thickness<span class="op">);</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>intersecting<span class="op">)</span></span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#123;</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fu">GetSource</span><span class="op">(</span>hitUV<span class="op">)+</span>col<span class="op">;</span> </span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#125;</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>    <span class="op">&#125;</span></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">float4</span><span class="op">(</span>col<span class="op">);</span></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a><span class="co">//用HiZ优化的SSR</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>float4 <span class="fu">HiZSSRfrag</span> <span class="op">(</span>v2f i<span class="op">)</span> <span class="op">:</span> SV_Target</span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>    <span class="co">//采样数据</span></span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>    float2 uv <span class="op">=</span> <span class="fu">UnityStereoTransformScreenSpaceTex</span><span class="op">(</span>i<span class="op">.</span><span class="fu">uv</span><span class="op">);</span></span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> Depth <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X</span><span class="op">(</span>_CameraDepthTexture<span class="op">,</span>sampler_CameraDepthTexture<span class="op">,</span>uv<span class="op">).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>    Depth <span class="op">=</span> <span class="fu">LinearEyeDepth</span><span class="op">(</span>Depth<span class="op">,</span>_ZBufferParams<span class="op">);</span></span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>    float3 Normal <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X</span><span class="op">(</span>_CameraNormalsTexture<span class="op">,</span>sampler_CameraNormalsTexture<span class="op">,</span>uv<span class="op">);</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>    float4 col <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X</span><span class="op">(</span>_BlitTexture<span class="op">,</span> sampler_LinearClamp<span class="op">,</span> uv<span class="op">);</span><span class="co">//采样前屏幕纹理</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>    <span class="co">//深度图还原世界坐标</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>    float3 viewPos <span class="op">=</span> <span class="fu">ReconstructViewPos</span><span class="op">(</span>uv<span class="op">,</span>Depth<span class="op">);</span></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>    float3 posWS <span class="op">=</span> _WorldSpaceCameraPos<span class="op">+</span>viewPos<span class="op">;</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>    <span class="co">//视空间反射方向</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>    float3 vDir <span class="op">=</span> <span class="bu">normalize</span><span class="op">(</span>viewPos<span class="op">);</span></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>    float3 vrDir <span class="op">=</span> <span class="fu">TransformWorldToViewDir</span><span class="op">(</span><span class="bu">normalize</span><span class="op">(</span><span class="bu">reflect</span><span class="op">(</span>vDir<span class="op">,</span>Normal<span class="op">)));</span></span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>    <span class="co">//视空间的光线步进</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*UNITY_LOOP</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a><span class="co">    for(int i=0;i&lt;100;i++)</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a><span class="co">    &#123;</span></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a><span class="co">        float3 viewPos2 = viewPos+vrDir*i*_Stride;</span></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a><span class="co">        float2 uv2;  </span></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a><span class="co">        float stepDepth;  </span></span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a><span class="co">        ReconstructUVAndDepth(viewPos2, uv2, stepDepth);</span></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a><span class="co">        float stepRawDepth = SAMPLE_TEXTURE2D_X(_CameraDepthTexture,sampler_CameraDepthTexture,uv2).r;  </span></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a><span class="co">        float stepSurfaceDepth = LinearEyeDepth(stepRawDepth, _ZBufferParams);  </span></span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a><span class="co">        if (stepSurfaceDepth &lt; stepDepth &amp;&amp; stepDepth &lt; stepSurfaceDepth + _Thickness)</span></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a><span class="co">            return SAMPLE_TEXTURE2D_X(_BlitTexture, sampler_LinearClamp, uv2);  </span></span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a><span class="co">    &#125;</span></span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a><span class="co">    return float4(0,0,0,1);*/</span></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>    <span class="co">//屏幕空间的光线步进（DDA画线法）</span></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>    <span class="co">//首先规定最大步进长度（自定义最大步进终点，这样才能DDA画线）</span></span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> magnitude <span class="op">=</span> _MaxDistance<span class="op">;</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>    float3 startView <span class="op">=</span> <span class="fu">TransformWorldToView</span><span class="op">(</span>posWS<span class="op">);</span><span class="co">//视空间起点</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> end <span class="op">=</span> startView<span class="op">.</span><span class="fu">z</span> <span class="op">+</span> vrDir<span class="op">.</span><span class="fu">z</span> <span class="op">*</span> magnitude<span class="op">;</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>end <span class="op">&gt;</span> <span class="op">-</span>_ProjectionParams<span class="op">.</span><span class="fu">y</span><span class="op">)</span></span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>        magnitude <span class="op">=</span> <span class="op">(-</span>_ProjectionParams<span class="op">.</span><span class="fu">y</span> <span class="op">-</span> startView<span class="op">.</span><span class="fu">z</span><span class="op">)</span> <span class="op">/</span> vrDir<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>    float3 endView <span class="op">=</span> startView<span class="op">+</span>vrDir<span class="op">*</span>magnitude<span class="op">;</span><span class="co">//视空间终点</span></span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>    float4 startHScreen <span class="op">=</span> <span class="fu">TransformViewToHScreen</span><span class="op">(</span>startView<span class="op">,</span> _SourceSize<span class="op">.</span><span class="fu">xy</span><span class="op">);</span><span class="co">//屏幕空间起点</span></span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>    float4 endHScreen <span class="op">=</span> <span class="fu">TransformViewToHScreen</span><span class="op">(</span>endView<span class="op">,</span> _SourceSize<span class="op">.</span><span class="fu">xy</span><span class="op">);</span><span class="co">//屏幕空间终点</span></span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>    <span class="co">//1/k</span></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> startK <span class="op">=</span> <span class="fl">1.0</span><span class="op">/</span>startHScreen<span class="op">.</span><span class="fu">w</span><span class="op">;</span></span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> endK <span class="op">=</span> <span class="fl">1.0</span><span class="op">/</span>endHScreen<span class="op">.</span><span class="fu">w</span><span class="op">;</span></span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>    <span class="co">//与之前的屏幕坐标有什么区别？？？</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>    float2 startScreen <span class="op">=</span> startHScreen<span class="op">.</span><span class="fu">xy</span><span class="op">*</span>startK<span class="op">;</span></span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>    float2 endScreen <span class="op">=</span> endHScreen<span class="op">.</span><span class="fu">xy</span> <span class="op">*</span> endK<span class="op">;</span></span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>    <span class="co">//齐次除法视坐标？？？？</span></span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>    float3 startQ <span class="op">=</span> startView<span class="op">*</span>startK<span class="op">;</span></span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>    float3 endQ <span class="op">=</span> endView<span class="op">*</span>endK<span class="op">;</span></span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>    <span class="co">//斜率切换xy</span></span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>    float2 diff <span class="op">=</span> endScreen<span class="op">-</span>startScreen<span class="op">;</span></span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> permute <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span><span class="op">(</span><span class="bu">abs</span><span class="op">(</span>diff<span class="op">.</span><span class="fu">x</span><span class="op">)&lt;</span><span class="bu">abs</span><span class="op">(</span>diff<span class="op">.</span><span class="fu">y</span><span class="op">))</span></span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>    <span class="op">&#123;</span></span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>        permute <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>        diff <span class="op">=</span> diff<span class="op">.</span><span class="fu">yx</span><span class="op">;</span></span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>        startScreen <span class="op">=</span> startScreen<span class="op">.</span><span class="fu">yx</span><span class="op">;</span></span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>        endScreen <span class="op">=</span> endScreen<span class="op">.</span><span class="fu">yx</span><span class="op">;</span></span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>    <span class="op">&#125;</span></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>    <span class="co">//计算屏幕坐标，齐次坐标，inverse-w的线性增量</span></span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dir <span class="op">=</span> <span class="bu">sign</span><span class="op">(</span>diff<span class="op">.</span><span class="fu">x</span><span class="op">);</span></span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> invdx <span class="op">=</span> dir<span class="op">/</span>diff<span class="op">.</span><span class="fu">x</span><span class="op">;</span></span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>    float2 dp <span class="op">=</span> <span class="fu">float2</span><span class="op">(</span>dir<span class="op">,</span>invdx<span class="op">*</span>diff<span class="op">.</span><span class="fu">y</span><span class="op">);</span><span class="co">//步进方向</span></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>    float3 dq <span class="op">=</span> <span class="op">(</span>endQ<span class="op">-</span>startQ<span class="op">)*</span>invdx<span class="op">;</span></span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> dk <span class="op">=</span> <span class="op">(</span>endK<span class="op">-</span>startK<span class="op">)*</span>invdx<span class="op">;</span></span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>    dp <span class="op">*=</span>_Stride<span class="op">;</span><span class="co">//步进方向*距离</span></span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>    dq <span class="op">*=</span>_Stride<span class="op">;</span></span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>    dk <span class="op">*=</span>_Stride<span class="op">;</span></span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>    <span class="co">//缓存当前深度和位置(为什么这些都是同一深度）</span></span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> rayZMin <span class="op">=</span> startView<span class="op">.</span><span class="fu">z</span><span class="op">;</span>  </span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> rayZMax <span class="op">=</span> startView<span class="op">.</span><span class="fu">z</span><span class="op">;</span>  </span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> preZ <span class="op">=</span> startView<span class="op">.</span><span class="fu">z</span><span class="op">;</span></span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> mipLevel <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>    <span class="co">//float2 hitUV = 0.0;</span></span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a>    float2 P <span class="op">=</span> startScreen<span class="op">;</span></span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>    float3 Q <span class="op">=</span> startQ<span class="op">;</span></span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> K <span class="op">=</span> startK<span class="op">;</span></span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*// Binary抖动</span></span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a><span class="co">    float2 ditherUV = fmod(P, 4);</span></span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a><span class="co">    float jitter = lerp(1, dither[ditherUV.x * 3 + ditherUV.y],float3(0.2,0,1));</span></span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a><span class="co">    P += dp * jitter;</span></span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a><span class="co">    Q += dq * jitter;</span></span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a><span class="co">    K += dk * jitter;*/</span></span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>    <span class="co">//屏幕空间光线步进</span></span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a>    UNITY_LOOP</span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>_StepCount<span class="op">;</span>i<span class="op">++)</span></span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a>    <span class="op">&#123;</span></span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a>        <span class="co">//步进</span></span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a>        P <span class="op">+=</span>dp<span class="op">*</span><span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span><span class="co">//屏幕空间步进一个像素</span></span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>        Q <span class="op">+=</span>dq<span class="op">*</span><span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span><span class="co">//深度步进</span></span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a>        K <span class="op">+=</span>dk<span class="op">*</span><span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span><span class="co">//K值也跟着增加</span></span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>        <span class="co">//步进前后两点的深度</span></span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>        rayZMin <span class="op">=</span> preZ<span class="op">;</span></span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a>        rayZMax <span class="op">=</span> <span class="op">(</span>dq<span class="op">.</span><span class="fu">z</span><span class="op">*</span><span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">)*</span><span class="fl">0.5</span><span class="op">+</span>Q<span class="op">.</span><span class="fu">z</span><span class="op">)/(</span>dk<span class="op">*</span><span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">)*</span><span class="fl">0.5</span><span class="op">+</span>K<span class="op">);</span></span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>        preZ <span class="op">=</span> rayZMax<span class="op">;</span></span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span>rayZMin<span class="op">&gt;</span>rayZMax<span class="op">)</span></span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#123;</span></span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a>            <span class="fu">swap</span><span class="op">(</span>rayZMin<span class="op">,</span> rayZMax<span class="op">);</span>  </span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#125;</span></span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a>        <span class="co">//得到交点UV</span></span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a>        float2 hitUV <span class="op">=</span> permute<span class="op">?</span>P<span class="op">.</span><span class="fu">yx</span><span class="op">:</span>P<span class="op">;</span></span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>        hitUV <span class="op">*=</span>_SourceSize<span class="op">.</span><span class="fu">zw</span><span class="op">;</span></span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span><span class="op">(</span><span class="bu">any</span><span class="op">(</span>hitUV<span class="op">&lt;</span><span class="fl">0.0</span><span class="op">)||</span><span class="bu">any</span><span class="op">(</span>hitUV<span class="op">&gt;</span><span class="fl">1.0</span><span class="op">))</span></span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#123;</span></span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span><span class="op">(</span>mipLevel<span class="op">==</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>            <span class="op">&#123;</span></span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="fu">float4</span><span class="op">(</span>col<span class="op">);</span></span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a>            <span class="op">&#125;</span></span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>            <span class="kw">else</span></span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a>            <span class="op">&#123;</span></span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a>                P <span class="op">-=</span> dp <span class="op">*</span> <span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span></span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>                Q <span class="op">-=</span> dq <span class="op">*</span> <span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span></span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a>                K <span class="op">-=</span> dk <span class="op">*</span> <span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span></span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a>                preZ <span class="op">=</span> Q<span class="op">.</span><span class="fu">z</span> <span class="op">/</span> K<span class="op">;</span></span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a>                mipLevel<span class="op">--;</span></span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a>                <span class="kw">break</span><span class="op">;</span></span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a>            <span class="op">&#125;</span></span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#125;</span></span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> rawDepth <span class="op">=</span> <span class="fu">SAMPLE_TEXTURE2D_X_LOD</span><span class="op">(</span>_HierarchicalZBufferTexture<span class="op">,</span> sampler_PointClamp<span class="op">,</span> hitUV<span class="op">,</span> mipLevel<span class="op">).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> surfaceDepth <span class="op">=</span> <span class="op">-</span><span class="fu">LinearEyeDepth</span><span class="op">(</span>rawDepth<span class="op">,</span> _ZBufferParams<span class="op">);</span></span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> isBehind <span class="op">=</span> rayZMin<span class="fl">+0.01</span> <span class="op">&lt;=</span> surfaceDepth<span class="op">;</span><span class="co">//防止步进步数过小，自反射；</span></span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(!</span>isBehind<span class="op">)</span></span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#123;</span></span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a>            mipLevel <span class="op">=</span> <span class="bu">min</span><span class="op">(</span>mipLevel <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> _MaxHierarchicalZBufferTextureMipLevel<span class="op">);</span></span>
<span id="cb1-364"><a href="#cb1-364" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#125;</span></span>
<span id="cb1-365"><a href="#cb1-365" aria-hidden="true" tabindex="-1"></a>        <span class="kw">else</span></span>
<span id="cb1-366"><a href="#cb1-366" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#123;</span></span>
<span id="cb1-367"><a href="#cb1-367" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(</span>mipLevel <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb1-368"><a href="#cb1-368" aria-hidden="true" tabindex="-1"></a>            <span class="op">&#123;</span></span>
<span id="cb1-369"><a href="#cb1-369" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> <span class="op">(</span><span class="bu">abs</span><span class="op">(</span>surfaceDepth <span class="op">-</span> rayZMax<span class="op">)</span> <span class="op">&lt;</span> _Thickness<span class="op">)</span></span>
<span id="cb1-370"><a href="#cb1-370" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">return</span> <span class="fu">GetSource</span><span class="op">(</span>hitUV<span class="op">)+</span>col<span class="op">;</span></span>
<span id="cb1-371"><a href="#cb1-371" aria-hidden="true" tabindex="-1"></a>            <span class="op">&#125;</span></span>
<span id="cb1-372"><a href="#cb1-372" aria-hidden="true" tabindex="-1"></a>            <span class="kw">else</span></span>
<span id="cb1-373"><a href="#cb1-373" aria-hidden="true" tabindex="-1"></a>            <span class="op">&#123;</span></span>
<span id="cb1-374"><a href="#cb1-374" aria-hidden="true" tabindex="-1"></a>                P <span class="op">-=</span> dp <span class="op">*</span> <span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span></span>
<span id="cb1-375"><a href="#cb1-375" aria-hidden="true" tabindex="-1"></a>                Q <span class="op">-=</span> dq <span class="op">*</span> <span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span></span>
<span id="cb1-376"><a href="#cb1-376" aria-hidden="true" tabindex="-1"></a>                K <span class="op">-=</span> dk <span class="op">*</span> <span class="bu">exp2</span><span class="op">(</span>mipLevel<span class="op">);</span></span>
<span id="cb1-377"><a href="#cb1-377" aria-hidden="true" tabindex="-1"></a>                preZ <span class="op">=</span> Q<span class="op">.</span><span class="fu">z</span> <span class="op">/</span> K<span class="op">;</span></span>
<span id="cb1-378"><a href="#cb1-378" aria-hidden="true" tabindex="-1"></a>                mipLevel<span class="op">--;</span></span>
<span id="cb1-379"><a href="#cb1-379" aria-hidden="true" tabindex="-1"></a>            <span class="op">&#125;</span></span>
<span id="cb1-380"><a href="#cb1-380" aria-hidden="true" tabindex="-1"></a>        <span class="op">&#125;</span></span>
<span id="cb1-381"><a href="#cb1-381" aria-hidden="true" tabindex="-1"></a>    <span class="op">&#125;</span></span>
<span id="cb1-382"><a href="#cb1-382" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fu">float4</span><span class="op">(</span>col<span class="op">);</span></span>
<span id="cb1-383"><a href="#cb1-383" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span>
<span id="cb1-384"><a href="#cb1-384" aria-hidden="true" tabindex="-1"></a><span class="co">//生成HiZ的深度图用片源着色器</span></span>
<span id="cb1-385"><a href="#cb1-385" aria-hidden="true" tabindex="-1"></a>float4 <span class="fu">HiZfrag</span> <span class="op">(</span>v2f i<span class="op">)</span> <span class="op">:</span> SV_Target</span>
<span id="cb1-386"><a href="#cb1-386" aria-hidden="true" tabindex="-1"></a><span class="op">&#123;</span></span>
<span id="cb1-387"><a href="#cb1-387" aria-hidden="true" tabindex="-1"></a>    float2 uv <span class="op">=</span> i<span class="op">.</span><span class="fu">uv</span><span class="op">;</span></span>
<span id="cb1-388"><a href="#cb1-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-389"><a href="#cb1-389" aria-hidden="true" tabindex="-1"></a>    float4 minDepth <span class="op">=</span> <span class="fu">float4</span><span class="op">(</span></span>
<span id="cb1-390"><a href="#cb1-390" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GetHiZSoure</span><span class="op">(</span>uv<span class="op">,</span> <span class="fu">float2</span><span class="op">(-</span><span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">),</span> _HierarchicalZBufferTextureFromMipLevel<span class="op">).</span><span class="fu">r</span><span class="op">,</span></span>
<span id="cb1-391"><a href="#cb1-391" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GetHiZSoure</span><span class="op">(</span>uv<span class="op">,</span> <span class="fu">float2</span><span class="op">(-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">),</span> _HierarchicalZBufferTextureFromMipLevel<span class="op">).</span><span class="fu">r</span><span class="op">,</span></span>
<span id="cb1-392"><a href="#cb1-392" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GetHiZSoure</span><span class="op">(</span>uv<span class="op">,</span> <span class="fu">float2</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">),</span> _HierarchicalZBufferTextureFromMipLevel<span class="op">).</span><span class="fu">r</span><span class="op">,</span></span>
<span id="cb1-393"><a href="#cb1-393" aria-hidden="true" tabindex="-1"></a>        <span class="fu">GetHiZSoure</span><span class="op">(</span>uv<span class="op">,</span> <span class="fu">float2</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">),</span> _HierarchicalZBufferTextureFromMipLevel<span class="op">).</span><span class="fu">r</span></span>
<span id="cb1-394"><a href="#cb1-394" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb1-395"><a href="#cb1-395" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> MaxDepth <span class="op">=</span> <span class="bu">max</span><span class="op">(</span><span class="bu">max</span><span class="op">(</span>minDepth<span class="op">.</span><span class="fu">r</span><span class="op">,</span> minDepth<span class="op">.</span><span class="fu">g</span><span class="op">),</span> <span class="bu">max</span><span class="op">(</span>minDepth<span class="op">.</span><span class="fu">b</span><span class="op">,</span> minDepth<span class="op">.</span><span class="fu">a</span><span class="op">));</span></span>
<span id="cb1-396"><a href="#cb1-396" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> MaxDepth<span class="op">;</span></span>
<span id="cb1-397"><a href="#cb1-397" aria-hidden="true" tabindex="-1"></a><span class="op">&#125;</span></span></code></pre></div>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 90%" />
</colgroup>
<thead>
<tr>
<th style="text-align: center;">555</th>
<th style="text-align: left;">555</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">555</td>
<td style="text-align: left;">555</td>
</tr>
<tr>
<td style="text-align: center;">555</td>
<td style="text-align: left;">555</td>
</tr>
<tr>
<td style="text-align: center;">555</td>
<td style="text-align: left;">555</td>
</tr>
</tbody>
</table>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 枫雪のHome
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;枫雪
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    




    
</body>
</html>
