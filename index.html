
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <title>枫雪のHome</title>
    <meta name="author" content="枫雪" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>





<script src="/js/lib/home.js"></script>

<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>枫雪のHOME</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;主页</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;关于我</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;归档</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;分类</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;标签</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;枫雪のHOME</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">主页</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">关于我</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">归档</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">分类</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">标签</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div id="home-head">
    <div
        id="home-background"
        ref="homeBackground"
        data-images="/images/background3.jpg"
    ></div>
    <div id="home-info" @click="homeClick">
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="loop"></span>
        <span class="info">
            <div class="wrap">
                <h1>枫雪のHome</h1>
                <h3>“可爱的少女心，可是无所不能的哦♪～”</h3>
                <h5></h5>
            </div>
        </span>
    </div>
</div>
<div
    id="home-posts-wrap"
    ref="homePostsWrap"
    true
>
    <div id="home-posts">
        

<div class="post">
    <a href="/2025/07/04/%E8%87%AA%E5%AE%9A%E4%B9%89URP%E7%AE%A1%E7%BA%BF%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%B8%B2%E6%9F%93/">
        <h2 class="post-title">自定义URP管线的延迟渲染</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/7/4
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <h2 id="1-修改管线"><a href="#1-修改管线" class="headerlink" title="1.修改管线"></a>1.修改管线</h2><p>由于我们直接修改URP的代码会被自动改回去，为了让我们修改的代码能够保存，我们要将项目文件夹下Library\PackageCache中的<a href="mailto:&#x63;&#111;&#109;&#46;&#117;&#110;&#x69;&#116;&#x79;&#x2e;&#114;&#101;&#110;&#100;&#x65;&#x72;&#45;&#x70;&#x69;&#x70;&#101;&#108;&#x69;&#x6e;&#x65;&#x73;&#x2e;&#x75;&#x6e;&#105;&#118;&#x65;&#x72;&#115;&#x61;&#108;&#x40;&#x31;&#x34;&#46;&#x30;&#x2e;&#x31;&#x30;">com.unity.render-pipelines.universal@14.0.10</a>剪切到项目文件夹下的Packages文件中</p>
<p><img src="https://pic3.zhimg.com/v2-516719dabacc80da231d746dec57d59a_1440w.jpg"></p>
<p>从左边到右边</p>
<p>如果没什么意外的话再打开untiy的话修改的代码应该就不会再该回去了。</p>
<h2 id="2-设置延迟管线"><a href="#2-设置延迟管线" class="headerlink" title="2.设置延迟管线"></a>2.设置延迟管线</h2><p>想自定义延迟管线的话第一步当然是先改成延迟管线，我们依次点击Edit-ProjectSettings，在Graphics中应该能看到有个选择当前管线的地方，点一下，就能定位到当前使用的管线。</p>
<p><img src="https://pic4.zhimg.com/v2-a42fdb2b35315ce8ce8e568d94248333_1440w.jpg"></p>
<p>就是这里</p>
<p>然后再点击这个管线的RendererList，就能找到修改为延迟管线的地方</p>
<p><img src="https://picx.zhimg.com/v2-8dd3596618902ff73bb8891db5d6ac31_1440w.jpg"></p>
<p>然后RenderingPath从Forward改为Deferred</p>
<p><img src="https://pic2.zhimg.com/v2-bd386f609edb34736594013a1614867f_1440w.jpg"></p>
<h2 id="3-GbufferPass"><a href="#3-GbufferPass" class="headerlink" title="3.GbufferPass"></a>3.GbufferPass</h2><p>总所周知，延迟渲染主要由传递数据的GbufferPass和计算光照的<a target="_blank" rel="noopener" href="https://zhida.zhihu.com/search?content_id=247600342&content_type=Article&match_order=1&q=LightPass&zhida_source=entity">LightPass</a>组成。这里我们先讲GbufferPass。</p>
<p>untiy没给统一的URPshader模板，这里先给个我的URP模板方便后续更改：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Gbuffer&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;MainTex&quot;,2D) = &quot;white&quot;&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;RenderType&quot;=&quot;Opaque&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        //渲染的pass</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;LightMode&quot;=&quot;UniversalForward&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;</span><br><span class="line">            #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">            struct a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float4 uv : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line">            struct v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 posCS : SV_POSITION;</span><br><span class="line">                float2 uv : TEXCOORD;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line"></span><br><span class="line">	    CBUFFER_END</span><br><span class="line">            TEXTURE2D(_MainTex);</span><br><span class="line">            SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            v2f vert(a2v v)</span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                </span><br><span class="line">               </span><br><span class="line">                VertexPositionInputs vertexInput = GetVertexPositionInputs(v.vertex.xyz);</span><br><span class="line">                o.posCS = vertexInput.positionCS;</span><br><span class="line">                o.uv = TRANSFORM_TEX(v.uv,_MainTex);</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line">            float4 frag(v2f i) : SV_Target</span><br><span class="line">	   &#123;</span><br><span class="line">                float4 MainTex = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">		return float4(MainTex);</span><br><span class="line">	   &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>URP会将所有LightMode为UniversalGBuffer的shader作为Gbuffer阶段的shader，所以我们首先修改LightMode</p>
<p><img src="https://pica.zhimg.com/v2-3f2b78d376806d1e291dd76f2fa4ea48_1440w.jpg"></p>
<p>总所周知：Gbuffer有4个，分别输出不同的信息用于后续的光照计算，我们创建个结构体，用于输出4个Gbuffer</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//将Gubffer打包成结构体输出</span><br><span class="line">            struct DeferredOutPut&#123;</span><br><span class="line">                float4 gBuffer0 : SV_TARGET0;</span><br><span class="line">                float4 gBuffer1 : SV_TARGET1;</span><br><span class="line">                float4 gBuffer2 : SV_TARGET2;</span><br><span class="line">                float4 gBuffer3 : SV_TARGET3;</span><br><span class="line">            &#125;;</span><br></pre></td></tr></table></figure>

<p>然后我们相应的修改我们的片源着色器，这里我只是往4个Buffer中塞了一堆1</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">          DeferredOutPut frag(v2f i) : SV_Target</span><br><span class="line">  &#123;</span><br><span class="line">DeferredOutPut g;</span><br><span class="line">              <span class="comment">//贴图采样</span></span><br><span class="line">              float4 MainTex = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">g.gBuffer0 = float4(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);</span><br><span class="line">g.gBuffer1 = float4(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);</span><br><span class="line">g.gBuffer2 = float4(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);</span><br><span class="line">g.gBuffer3 = float4(<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>,<span class="number">1.0</span>);</span><br><span class="line">return g;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这四个Buffer官方给的精度各不相同，用于应对不同的数据，官方的做法是Gbuffer0：RGB漫反射，A：材质ID？（不确定，不懂是干什么用的），Gbuffer1：RGB高光，A：AO ，Gbuffer2：RGB法线，A：光滑度，Gbuffer3：RGB环境光和自发光，A：无（是个1）。</p>
<p><img src="https://picx.zhimg.com/v2-cda10c00dea630f9f06268a80c3615a7_1440w.jpg"></p>
<p>官方的输出</p>
<p>我们可以在FrameDebugger中看到它们各自的精度：</p>
<p><img src="https://pic2.zhimg.com/v2-e1c57a1a17d0befb752fd478bf9a9117_1440w.jpg"></p>
<p>Gbuffer0</p>
<p><img src="https://pic4.zhimg.com/v2-2ae8726950e8176bda68f44d2b33a935_1440w.jpg"></p>
<p>Gbuffer1</p>
<p><img src="https://picx.zhimg.com/v2-6dd1d116130b2ee343f21813ae2faf4f_1440w.jpg"></p>
<p>Gbuffer2</p>
<p><img src="https://picx.zhimg.com/v2-75fa58529419d89add7dc28fa977af1b_1440w.jpg"></p>
<p>Gbuffer3</p>
<p>可以看到Gbuffer3的精度给的最高，因为他考虑到环境光和自发光可能需要HDR，并且没A通道，所以想往A通道塞东西得改代码（后面会说）。</p>
<p>完整的Gbuffer部分：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Gbuffer&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;MainTex&quot;,2D) = &quot;white&quot;&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;RenderType&quot;=&quot;Opaque&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        //渲染的pass</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;LightMode&quot;=&quot;UniversalGBuffer&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;</span><br><span class="line">            #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">            struct a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float4 uv : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line">            struct v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 posCS : SV_POSITION;</span><br><span class="line">                float2 uv : TEXCOORD;</span><br><span class="line">            &#125;;</span><br><span class="line">            //将Gubffer打包成结构体输出</span><br><span class="line">            struct DeferredOutPut&#123;</span><br><span class="line">                float4 gBuffer0 : SV_TARGET0;</span><br><span class="line">                float4 gBuffer1 : SV_TARGET1;</span><br><span class="line">                float4 gBuffer2 : SV_TARGET2;</span><br><span class="line">                float4 gBuffer3 : SV_TARGET3;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line"></span><br><span class="line">	    CBUFFER_END</span><br><span class="line">            TEXTURE2D(_MainTex);//在CG中会写成sampler2D _MainTex;</span><br><span class="line">            SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            v2f vert(a2v v)</span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                </span><br><span class="line">                //URP获得裁剪和世界空间顶点</span><br><span class="line">                VertexPositionInputs vertexInput = GetVertexPositionInputs(v.vertex.xyz);</span><br><span class="line">                o.posCS = vertexInput.positionCS;</span><br><span class="line">                o.uv = TRANSFORM_TEX(v.uv,_MainTex);</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line">            //片源着色器</span><br><span class="line">            DeferredOutPut frag(v2f i) : SV_Target</span><br><span class="line">	    &#123;</span><br><span class="line">		DeferredOutPut g;</span><br><span class="line">                //贴图采样</span><br><span class="line">                float4 MainTex = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">		g.gBuffer0 = float4(1.0,1.0,1.0,1.0);</span><br><span class="line">		g.gBuffer1 = float4(1.0,1.0,1.0,1.0);</span><br><span class="line">		g.gBuffer2 = float4(1.0,1.0,1.0,1.0);</span><br><span class="line">		g.gBuffer3 = float4(1.0,1.0,1.0,1.0);</span><br><span class="line">		return g;</span><br><span class="line">	     &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-LightPass"><a href="#4-LightPass" class="headerlink" title="4.LightPass"></a>4.LightPass</h2><p>老的渲染管线可以自己写个LightPass然后在untiy中直接替换，但URP中却不能用这样的方式，所以我们直接去修改URP的shader（其实是有别的方式，可以用自己的shader，但我不会）。</p>
<p>我们去翻FrameDebugger，直接打开URP的LightPass</p>
<p><img src="https://pic2.zhimg.com/v2-a55ec232c61700d6964ef9182bb9eb75_1440w.jpg"></p>
<p>直接点那个shader就能定位到位置</p>
<p>他是一个700多行的shader，挺多，别慌，其实untiy用到的就是其中的一两个Pass，也就是3，4Pass，这点也可以在FrameDebugger中看到：</p>
<p><img src="https://pic4.zhimg.com/v2-1cfa5b1a2109998748cc0dff6d24b9a5_1440w.jpg"></p>
<p>URP所使用的Pass</p>
<p>我们打开那个shader看看这俩pass分别写了什么：</p>
<p><img src="https://pic4.zhimg.com/v2-614bf4388f77385295225598de3f6f8d_1440w.jpg"></p>
<p><img src="https://pic1.zhimg.com/v2-3e285dcc38e15de599ed346636cb101e_1440w.jpg"></p>
<p>关键在于红框的位置，注释部分标明了这个pass的用途，下面则写了他所使用的顶点片源着色器，这两个pass所使用的片源着色器是相同的，这就方便了我们的修改，我们的目的正是修改片源着色器的部分</p>
<p><img src="https://picx.zhimg.com/v2-4a75f4b665da8e9a976777e710c97cdf_1440w.jpg"></p>
<p>URP的片源着色器部分</p>
<p><img src="https://pic2.zhimg.com/v2-8dd35308d5c1eedcb9cf977095f16ec7_1440w.jpg"></p>
<p>接上图</p>
<p><img src="https://pica.zhimg.com/v2-52418289d6beca87d1b5dc6bfcc4c162_1440w.jpg"></p>
<p>接上图</p>
<p>其中有各种乱七八糟的宏来定义各种情况，咱不用管，关键在于两个地方：其一是采样Gbuffer的方式，我们可以直接用URP的</p>
<p><img src="https://pic2.zhimg.com/v2-9f380795257610956a5bec27ef33508f_1440w.jpg"></p>
<p>这里是3个Gbuffer和一个深度</p>
<p>可以看到unity只采样了前3个buffer，而gbuffer3却没有采样。这是因为unity会自动将gbuffer3给加到最后的return中，这点需要注意，我们在计算的过程中别再加一遍gbuffer3的数值了，也意味着gbuffer3只能存一些能直接加的东西，一些花里胡哨的东西就别往gbuffer3里存了。</p>
<p>第二个关键点在于深度图重构世界坐标的方式，我们可以直接用unity的方式：</p>
<p><img src="https://pic2.zhimg.com/v2-d7ab327ed5d028844f4a60664a1f15e5_1440w.jpg"></p>
<p>深度图重构世界坐标</p>
<p>其中eyeIndex是关于适配xr的，我们不去管xr，直接把eyeIndex改成0，他是我们正常使用的矩阵</p>
<p>剩下的地方咱删了自己写：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">half4 DeferredShading(Varyings input) : SV_Target</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    float2 screen_uv = (input.screenUV.xy / input.screenUV.z);</span><br><span class="line">    </span><br><span class="line">    float d        = SAMPLE_TEXTURE2D_X_LOD(_CameraDepthTexture, my_point_clamp_sampler, screen_uv, 0).x; // raw depth value has UNITY_REVERSED_Z applied on most platforms.</span><br><span class="line">    half4 gbuffer0 = SAMPLE_TEXTURE2D_X_LOD(_GBuffer0, my_point_clamp_sampler, screen_uv, 0);</span><br><span class="line">    half4 gbuffer1 = SAMPLE_TEXTURE2D_X_LOD(_GBuffer1, my_point_clamp_sampler, screen_uv, 0);</span><br><span class="line">    half4 gbuffer2 = SAMPLE_TEXTURE2D_X_LOD(_GBuffer2, my_point_clamp_sampler, screen_uv, 0);</span><br><span class="line">    </span><br><span class="line">    float4 posWS = mul(_ScreenToWorld[0], float4(input.positionCS.xy, d, 1.0));</span><br><span class="line">    posWS.xyz *= rcp(posWS.w);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    return half4(gbuffer0.rgb, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我直接将gbuffer0的rgb输出来看结果，我将GbufferPass的gbuffer0输出改为MainTex，并且把Gbuffer3的值改为了0（防止unity直接将gbuffer3加上去影响对结果的判断）</p>
<p><img src="https://pic1.zhimg.com/v2-776fc0cc68617fb0b973268bf5ef1d1c_1440w.jpg"></p>
<p>加了贴图的结果</p>
<h2 id="5-法线"><a href="#5-法线" class="headerlink" title="5.法线"></a>5.法线</h2><p>由于法线是-1<del>1的数据，而Gbuffer是0</del>1的数据，所以我们需要在Gbuffer阶段编码一下，再到LightPass阶段解码一下。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//在GbufferPass</span><br><span class="line">float3 nDirWS = normalize(i.nDirWS)*0.5+0.5;</span><br><span class="line">g.gBuffer2 = float4(nDirWS,1.0);</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//在LightPass</span><br><span class="line">float3 nDirWS = gbuffer2.rgb*2-1;</span><br></pre></td></tr></table></figure>

<p>但是这种方式所得的结果法线精度会有不够的问题，计算兰伯特的时候会导致结果很丑：</p>
<p><img src="https://pic3.zhimg.com/v2-ae1c21e1e67f81a011b2e5ddfcec3ce6_1440w.jpg"></p>
<p>兰伯特结果</p>
<p><img src="https://pic1.zhimg.com/v2-9767e8a4f5b62dc99e706fe0679fb808_1440w.jpg"></p>
<p>半兰伯特结果</p>
<p>unity中有个设置，可以提高法线精度</p>
<p><img src="https://pic1.zhimg.com/v2-e92eed18f946368298f3a2b3f2978ffc_1440w.jpg"></p>
<p>就是这个选项</p>
<p>打开它，untiy会改变Gbuffer2的rt格式并且使用八面体映射的方式来进行编码法线（前提是你解码法线和编码法线是用的unity的函数）</p>
<p><img src="https://pic4.zhimg.com/v2-7686575122c00e91dad0ed8da4d051c3_1440w.jpg"></p>
<p>使用高精度法线后的rt格式</p>
<p><img src="https://pic1.zhimg.com/v2-80e42a9a7d8f68be3a6173f3b17c2238_1440w.jpg"></p>
<p>使用八面体映射编码后的法线（未解码）</p>
<p>这里我直接把unity八面体映射的编码和解码方式给搬过来：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//在GbufferPass（写在片源着色器前面）</span><br><span class="line">//八面体映射压缩法线，解决法线精度问题</span><br><span class="line">half3 EyPackNormal(half3 n)</span><br><span class="line">&#123;</span><br><span class="line">     float2 octNormalWS = PackNormalOctQuadEncode(n);                  // values between [-1, +1], must use fp32 on some platforms.</span><br><span class="line">     float2 remappedOctNormalWS = saturate(octNormalWS * 0.5 + 0.5);   // values between [ 0, +1]</span><br><span class="line">     return half3(PackFloat2To888(remappedOctNormalWS));               // values between [ 0, +1]</span><br><span class="line">&#125;</span><br><span class="line">//Gbufferpass的片源着色器中</span><br><span class="line">float3 nDirWS = normalize(i.nDirWS);</span><br><span class="line">nDirWS = EyPackNormal(nDirWS);</span><br><span class="line">g.gBuffer2 = float4(nDirWS,1.0);</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//LightPass的片源着色器前面</span><br><span class="line">//解码八面体映射的法线</span><br><span class="line">    half3 EyUnpackNormal(half3 pn)</span><br><span class="line">    &#123;</span><br><span class="line">        half2 remappedOctNormalWS = half2(Unpack888ToFloat2(pn));          // values between [ 0, +1]</span><br><span class="line">        half2 octNormalWS = remappedOctNormalWS.xy * half(2.0) - half(1.0);// values between [-1, +1]</span><br><span class="line">        return half3(UnpackNormalOctQuadEncode(octNormalWS));              // values between [-1, +1]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//在LightPass 的片源着色器里面</span><br><span class="line">float3 nDirWS = gbuffer2.rgb;</span><br><span class="line">nDirWS = EyUnpackNormal(nDirWS);</span><br></pre></td></tr></table></figure>

<p>这样之后法线精度就差不多了：</p>
<p><img src="https://pic3.zhimg.com/v2-4d61b373c5ddb5da7fff196b00dbe04c_1440w.jpg"></p>
<p>处理法线之后的半兰伯特</p>
<p>GbufferPass的完整代码如下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Gbuffer&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;MainTex&quot;,2D) = &quot;white&quot;&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags </span><br><span class="line">        &#123;</span><br><span class="line">            &quot;RenderType&quot;=&quot;Opaque&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        //渲染的pass</span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">            Tags</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;LightMode&quot;=&quot;UniversalGBuffer&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            #pragma vertex vert</span><br><span class="line">            #pragma fragment frag</span><br><span class="line">            #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;</span><br><span class="line">            #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&quot;</span><br><span class="line"></span><br><span class="line">            struct a2v</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float4 uv : TEXCOORD0;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">            &#125;;</span><br><span class="line">            struct v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 posCS : SV_POSITION;</span><br><span class="line">                float2 uv : TEXCOORD;</span><br><span class="line">                float3 nDirWS : TEXCOORD1;</span><br><span class="line">            &#125;;</span><br><span class="line">            //将Gubffer打包成结构体输出</span><br><span class="line">            struct DeferredOutPut&#123;</span><br><span class="line">                float4 gBuffer0 : SV_TARGET0;</span><br><span class="line">                float4 gBuffer1 : SV_TARGET1;</span><br><span class="line">                float4 gBuffer2 : SV_TARGET2;</span><br><span class="line">                float4 gBuffer3 : SV_TARGET3;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            CBUFFER_START(UnityPerMaterial)</span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line"></span><br><span class="line">			CBUFFER_END</span><br><span class="line">            TEXTURE2D(_MainTex);//在CG中会写成sampler2D _MainTex;</span><br><span class="line">            SAMPLER(sampler_MainTex);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            v2f vert(a2v v)</span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                </span><br><span class="line">                //URP获得裁剪和世界空间顶点</span><br><span class="line">                VertexPositionInputs vertexInput = GetVertexPositionInputs(v.vertex.xyz);</span><br><span class="line">                o.posCS = vertexInput.positionCS;</span><br><span class="line">                o.uv = TRANSFORM_TEX(v.uv,_MainTex);</span><br><span class="line">                o.nDirWS = TransformObjectToWorldNormal(v.normal.xyz) ;</span><br><span class="line">                return o;</span><br><span class="line">            &#125;</span><br><span class="line">            //八面体映射压缩法线，解决法线精度问题</span><br><span class="line">            half3 EyPackNormal(half3 n)</span><br><span class="line">            &#123;</span><br><span class="line">                float2 octNormalWS = PackNormalOctQuadEncode(n);                  // values between [-1, +1], must use fp32 on some platforms.</span><br><span class="line">                float2 remappedOctNormalWS = saturate(octNormalWS * 0.5 + 0.5);   // values between [ 0, +1]</span><br><span class="line">                return half3(PackFloat2To888(remappedOctNormalWS));               // values between [ 0, +1]</span><br><span class="line">            &#125;</span><br><span class="line">            //片源着色器</span><br><span class="line">            DeferredOutPut frag(v2f i) : SV_Target</span><br><span class="line">	    &#123;</span><br><span class="line">	        DeferredOutPut g;</span><br><span class="line">		//取数据</span><br><span class="line">		float3 nDirWS = normalize(i.nDirWS);</span><br><span class="line">                //贴图采样</span><br><span class="line">                float4 MainTex = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br><span class="line">		nDirWS = EyPackNormal(nDirWS);</span><br><span class="line">		g.gBuffer0 = float4(MainTex.rgb,1.0);</span><br><span class="line">		g.gBuffer1 = float4(1.0,1.0,1.0,1.0);</span><br><span class="line">		g.gBuffer2 = float4(nDirWS,1.0);</span><br><span class="line">		g.gBuffer3 = float4(0.0,0.0,0.0,0.0);</span><br><span class="line">		return g;</span><br><span class="line">	     &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LightPass部分代码如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//解码八面体映射的法线</span><br><span class="line">half3 EyUnpackNormal(half3 pn)</span><br><span class="line">&#123;</span><br><span class="line">    half2 remappedOctNormalWS = half2(Unpack888ToFloat2(pn));          // values between [ 0, +1]</span><br><span class="line">    half2 octNormalWS = remappedOctNormalWS.xy * half(2.0) - half(1.0);// values between [-1, +1]</span><br><span class="line">    return half3(UnpackNormalOctQuadEncode(octNormalWS));              // values between [-1, +1]</span><br><span class="line">&#125;</span><br><span class="line">half4 DeferredShading(Varyings input) : SV_Target</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    float2 screen_uv = (input.screenUV.xy / input.screenUV.z);</span><br><span class="line">    </span><br><span class="line">    float d        = SAMPLE_TEXTURE2D_X_LOD(_CameraDepthTexture, my_point_clamp_sampler, screen_uv, 0).x; // raw depth value has UNITY_REVERSED_Z applied on most platforms.</span><br><span class="line">    half4 gbuffer0 = SAMPLE_TEXTURE2D_X_LOD(_GBuffer0, my_point_clamp_sampler, screen_uv, 0);</span><br><span class="line">    half4 gbuffer1 = SAMPLE_TEXTURE2D_X_LOD(_GBuffer1, my_point_clamp_sampler, screen_uv, 0);</span><br><span class="line">    half4 gbuffer2 = SAMPLE_TEXTURE2D_X_LOD(_GBuffer2, my_point_clamp_sampler, screen_uv, 0);</span><br><span class="line"></span><br><span class="line">    //拿数据</span><br><span class="line">    float3 nDirWS = gbuffer2.rgb;</span><br><span class="line">    nDirWS = EyUnpackNormal(nDirWS);</span><br><span class="line">    float4 posWS = mul(_ScreenToWorld[0], float4(input.positionCS.xy, d, 1.0));</span><br><span class="line">    posWS.xyz *= rcp(posWS.w);</span><br><span class="line">    float3 color = dot(float3(1,0,0),nDirWS)*0.5+0.5;</span><br><span class="line">    return half4(color, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/33905696">这里贴个八面体映射的原理想了解可以去看看</a></p>
<h2 id="6-光照"><a href="#6-光照" class="headerlink" title="6.光照"></a>6.光照</h2><p>有了法线我们终于可以计算光照，首先是如何区分平行光和其他光。</p>
<p>URP是用一个宏来区分的：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#if defined(_DIRECTIONAL)</span><br><span class="line"></span><br><span class="line">#else</span><br><span class="line"></span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>if后面为平行光照，else后面为其他光源</p>
<p>先说平行光照。平行光照主要是需要它的方向、颜色（强度被包含在了颜色里），没什么好说的，用的话直接用下面的方法拿就行</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//计算光照</span><br><span class="line">#if defined(_DIRECTIONAL)</span><br><span class="line">float3 lDirWS = normalize( _MainLightPosition.xyz);</span><br><span class="line">float3 lightColor = _MainLightColor.rgb;</span><br><span class="line">#else</span><br><span class="line"></span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>然后是其他光源，主要是点光源和聚光灯。我这里完全没考虑聚光灯，只写了点光源相关，所以如果用了聚光灯的话结果可能会有些奇怪</p>
<p>对于点光源考虑的就多了：点光源的位置，光照方向，光照的衰减，颜色（强度也是被包含在颜色里了）</p>
<p>位置和颜色可以直接拿到：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float3 lightWS = _LightPosWS;//点光源的位置</span><br><span class="line">float3 lightColor = _LightColor.rgb;//颜色</span><br></pre></td></tr></table></figure>

<p>光照方向的话就是点光源位置减去模型的顶点位置（记得归一化）</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">float3 lightWS = _LightPosWS;//点光源的位置</span><br><span class="line">float3 lightColor = _LightColor.rgb;//颜色</span><br><span class="line">//计算光照方向</span><br><span class="line">float3 lightVector = lightWS - posWS.xyz;</span><br><span class="line">float3 lDirWS = normalize(lightVector);</span><br></pre></td></tr></table></figure>

<p>光照衰减：这里直接照搬unity的光照衰减。</p>
<p>原理的话可以看这篇文章：<a href="https://link.zhihu.com/?target=https://blog.csdn.net/qq_51603875/article/details/135847544">Unity中URP下额外灯的距离衰减_distanceattenuation-CSDN博客</a></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//计算衰减（暂时不管聚光灯）</span><br><span class="line">        float distanceSqr = max(dot(lightVector, lightVector), HALF_MIN);//防止取0</span><br><span class="line">        float4 attenuation = _LightAttenuation;</span><br><span class="line">        float lightAtten = rcp(distanceSqr);</span><br><span class="line">        float2 distanceAttenuationFloat = float2(attenuation.xy);</span><br><span class="line">        half factor = half(distanceSqr * distanceAttenuationFloat.x);</span><br><span class="line">        half smoothFactor = saturate(half(1.0) - factor * factor);</span><br><span class="line">        smoothFactor = smoothFactor * smoothFactor;</span><br><span class="line">        float distanceAttenuation = lightAtten * smoothFactor;</span><br></pre></td></tr></table></figure>

<p>相关部分完整代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//计算光照</span><br><span class="line">        #if defined(_DIRECTIONAL)</span><br><span class="line">        float3 lDirWS = normalize( _MainLightPosition.xyz);</span><br><span class="line">        float3 lightColor = _MainLightColor.rgb;</span><br><span class="line">        color = lightColor;</span><br><span class="line">        #else</span><br><span class="line">        float3 lightWS = _LightPosWS;//点光源的位置</span><br><span class="line">        float3 lightColor = _LightColor.rgb;//颜色</span><br><span class="line">        //计算光照方向</span><br><span class="line">        float3 lightVector = lightWS - posWS.xyz;</span><br><span class="line">        float3 lDirWS = normalize(lightVector);</span><br><span class="line">        //计算衰减（暂时不管聚光灯）</span><br><span class="line">        float distanceSqr = max(dot(lightVector, lightVector), HALF_MIN);//防止取0</span><br><span class="line">        float4 attenuation = _LightAttenuation;</span><br><span class="line">        float lightAtten = rcp(distanceSqr);</span><br><span class="line">        float2 distanceAttenuationFloat = float2(attenuation.xy);</span><br><span class="line">        half factor = half(distanceSqr * distanceAttenuationFloat.x);</span><br><span class="line">        half smoothFactor = saturate(half(1.0) - factor * factor);</span><br><span class="line">        smoothFactor = smoothFactor * smoothFactor;</span><br><span class="line">        float distanceAttenuation = lightAtten * smoothFactor;</span><br><span class="line">        #endif</span><br></pre></td></tr></table></figure>

<p>这里只是拿到各种光照相关数据，具体的光照计算可以根据自己的需求去实现</p>
<h2 id="7-修改RT"><a href="#7-修改RT" class="headerlink" title="7.修改RT"></a>7.修改RT</h2><p>有时候URPGbuffer的RT格式不能满足自己的需求，例如这里我用gbuffer2的a通道来传递半兰伯特的结果精度会很差（为什么R8G8B8A8_UNorm还会这么差）：</p>
<p><img src="https://pic4.zhimg.com/v2-1db1be7cf0d0bd0f0ccf2d9c1e374397_1440w.jpg"></p>
<p>将半兰伯特塞到Gbuffer2的A通道</p>
<p><img src="https://picx.zhimg.com/v2-7742e052ded4489d9206ee64c27e4f29_1440w.jpg"></p>
<p>结果</p>
<p>这就需要我们自己去修改RT的格式。</p>
<p>Gbuffer的RT格式是在DeferredLights.cs的GetGBufferFormat函数中定义的（我这里是第149行），我这里将Gbuffer2的RT直接改为R16G16B16A16_SFloat</p>
<p><img src="https://pic1.zhimg.com/v2-697fcd453570192be1eeea667054feba_1440w.jpg"></p>
<p>从上半部分可以看到之前法线精度开关在RT部分的实际用途</p>
<p><img src="https://pic1.zhimg.com/v2-828de6fdb9776d683229c342d1b4acc4_1440w.jpg"></p>
<p><img src="https://pic1.zhimg.com/v2-2ebe8c8a4662d36d5f488568b654d53e_1440w.jpg"></p>
<p>修改后的结果</p>
<p>这里只是举个范例，如果需要其他的修改直接改对应的Gbuffer就行</p>
<h2 id="8-在LightPass中插入自己的贴图"><a href="#8-在LightPass中插入自己的贴图" class="headerlink" title="8.在LightPass中插入自己的贴图"></a>8.在LightPass中插入自己的贴图</h2><p>如果做卡通渲染之类可能需要往LightPass中塞ramp贴图，他也在DeferredLights.cs中实现，先在ShaderConstants类中写一个PropertyToID</p>
<p><img src="https://pica.zhimg.com/v2-01d0e85492087016582cae59109bffc2_1440w.jpg"></p>
<p>然后在RenderStencilDirectionalLights函数的某for循环中（看图）SetGlobalTexture就行了</p>
<p><img src="https://pic2.zhimg.com/v2-f1ef3570bb7ea341ddc277dcf5641dc7_1440w.jpg"></p>
<p>然后就是在LightPass的shader中先声明一下（大概150行左右就能找到untiy声明变量的位置）</p>
<p><img src="https://pica.zhimg.com/v2-faf8ab905a6ebc7ba082dadebf20ed70_1440w.jpg"></p>
<p>在这声明</p>
<p>然后采样这个贴图的话就正常用SAMPLE_TEXTURE2D采样就行，没什么好说的</p>
<p>想要加一些贴图以外的变量也是类似的方式，<code>这里就不讲了</code></p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2025/07/04/%E8%87%AA%E5%AE%9A%E4%B9%89URP%E7%AE%A1%E7%BA%BF%E7%9A%84%E5%BB%B6%E8%BF%9F%E6%B8%B2%E6%9F%93/" class="go-post">阅读全文</a>
</div>

<div class="post">
    <a href="/2025/07/03/hello-world/">
        <h2 class="post-title">Hello World</h2>
    </a>
    <div class="category-and-date">
        
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2025/7/3
        </span>
        
        
    </div>
    <div class="description">
        <div class="content" v-pre>
            
            <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

            
        </div>
    </div>
    <div class="post-tags">
        
        
        
    </div>
    <a href="/2025/07/03/hello-world/" class="go-post">阅读全文</a>
</div>


        <div class="page-current">
    
    <span class="current">1</span>
    
    
    
    
</div>

    </div>
    
    <div id="home-card">
        <div id="card-style">
    <div id="card-div">
        <div class="avatar">
            <img src="/images/avatar.jpg" alt="avatar" />
        </div>
        <div class="name">枫雪</div>
        <div class="description">
            <p>想成为TA的TA<br>Elysia love</p>

        </div>
        
        
        <div class="friend-links">
            
            <div class="friend-link">
                <a target="_blank" rel="noopener" href="https://www.zhihu.com/people/huan-si-feng-xue-ling-luan">HLsama</a>
            </div>
            
        </div>
        
    </div>
</div>

    </div>
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2025 枫雪のHome
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;枫雪
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
</body>
</html>
